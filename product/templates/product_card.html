{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/product_card.css' %}">
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <!-- Карточка товара -->
            <div class="card product-detail-card border-0 shadow">
                <div class="row g-0">
                    <!-- Изображение и галерея -->
                    <div class="col-md-6">
                        <div class="h-100">
                            <!-- Основное изображение с возможностью увеличения -->
                            <div class="main-image-container position-relative bg-light p-3 rounded"
                                 style="min-height: 300px;">
                                {% if product.image %}
                                <img src="{{ product.image.url }}"
                                     class="img-fluid object-fit-contain modal-image main-product-image"
                                     alt="{{ product.title }}"
                                     style="max-height: 250px; cursor: zoom-in; width: 100%;"
                                     data-image-type="main">

                                {% else %}
                                <div class="d-flex align-items-center justify-content-center h-100">
                                    <i class="fas fa-image fa-4x text-muted"></i>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Галерея дополнительных изображений -->
                            {% if product.additionalimage_set.all %}
                            <div class="p-3 border-top">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-images me-2"></i>Дополнительные изображения
                                </h6>
                                <div class="row g-2">
                                    {% for image in product.additionalimage_set.all %}
                                    <div class="col-3 col-sm-2">
                                        <img src="{{ image.image.url }}"
                                             class="img-thumbnail modal-image w-100"
                                             alt="Изображение {{ forloop.counter }} {{ product.title }}"
                                             style="height: 60px; object-fit: cover; cursor: pointer;"
                                             data-image-type="gallery">
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Информация -->
                    <div class="col-md-6">
                        <div class="card-body h-100 d-flex flex-column">
                            <h1 class="h4 card-title">{{ product.title }}</h1>
                            <p class="text-muted">{{ product.category.name }}</p>

                            <div class="mb-3">
                                <span class="h3 text-primary">{{ product.price }} ₽</span>
                                {% if product.quantity > 0 %}
                                <span class="badge bg-success ms-2">В наличии</span>
                                {% else %}
                                <span class="badge bg-danger ms-2">Нет в наличии</span>
                                {% endif %}
                                {% if has_common %}
                                <span class="badge bg-info ms-2">Подходит к основному авто {{main_avto}}</span>
                                {% else %}
                                <span class="badge bg-secondary ms-2">Не подходит к основному авто</span>
                                {% endif %}
                            </div>

                            <!-- Общая информация -->
                            <div class="general-info mb-3">
                                <h6 class="fw-bold">Общая информация:</h6>
                                <div class="row">
                                    <div class="col-6 mb-2">
                                        <small class="text-muted">Артикул:</small>
                                        <br>
                                        <strong>{{ product.sku }}</strong>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <small class="text-muted">Категория:</small>
                                        <br>
                                        <strong>{{ product.category.name }}</strong>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <small class="text-muted">Наличие:</small>
                                        <br>
                                        <strong>
                                            {% if product.quantity > 0 %}
                                            {{ product.quantity }} шт.
                                            {% else %}
                                            Нет в наличии
                                            {% endif %}
                                        </strong>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <small class="text-muted">Дата добавления:</small>
                                        <br>
                                        <strong>{{ product.created_at|date:"d.m.Y" }}</strong>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2 mt-auto">
                                {% if product.quantity > 0 %}
                                <button class="btn btn-primary btn-lg">
                                    <i class="fas fa-shopping-cart me-2"></i>
                                    Добавить в корзину
                                </button>
                                {% else %}
                                <button class="btn btn-outline-secondary btn-lg" disabled>
                                    <i class="fas fa-times me-2"></i>
                                    Нет в наличии
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-secondary">
                                    <i class="far fa-heart me-2"></i>
                                    В избранное
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Блок с 4 кнопками для запросов к бекенду -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card border-0 shadow">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">Дополнительная информация</h5>
                        </div>
                        <div class="row g-3">
                            {% if has_descriptions %}
                            <div class="col-md-6 col-lg-3">
                                <button class="btn btn-outline-primary w-100 action-btn"
                                        data-action="descriptions">
                                    <i class="fas fa-car me-2"></i>Описание
                                </button>
                            </div>
                            {% endif %}

                            <div class="col-md-6 col-lg-3">
                                <button class="btn btn-outline-success w-100 action-btn py-2"
                                        data-action="reviews">
                                    <i class="fas fa-star me-2"></i>Отзывы
                                </button>
                            </div>

                            {% if has_specifications %}
                            <div class="col-md-6 col-lg-3">
                                <button class="btn btn-outline-info w-100 action-btn"
                                        data-action="specifications">
                                    <i class="fas fa-list-alt me-2"></i>Характеристики
                                </button>
                            </div>
                            {% endif %}


                            <div class="col-md-6 col-lg-3">
                                <button class="btn btn-outline-warning w-100 action-btn"
                                        data-action="questions">
                                    <i class="fas fa-exchange-alt me-2"></i>Ответ-Вопрос
                                </button>
                            </div>

                            {% if has_set %}
                            <div class="col-md-6 col-lg-3">
                                <button class="btn btn-outline-secondary w-100 action-btn"
                                        data-action="set">
                                    <i class="fas fa-exchange-alt me-2"></i>Входит в комплект
                                </button>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Контейнер для отображения результатов -->
                        <div id="api-results" class="mt-4" style="display: none;">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0" id="results-title">Результаты</h6>
                                    <button type="button" class="btn-close" onclick="closeResults()"></button>
                                </div>
                                <div class="card-body" id="results-content">
                                    <!-- Сюда будет загружаться контент -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для изображений (улучшенная версия) -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header border-0 position-absolute top-0 end-0 z-3">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-0 position-relative">
                <img id="modalImage" src="" class="img-fluid"
                     style="max-height: 90vh; object-fit: contain;"
                     alt="">
                <div class="position-absolute bottom-0 start-50 translate-middle-x mb-3">
                    <small class="text-white bg-dark bg-opacity-50 px-2 py-1 rounded">
                        Нажмите ESC или кликните outside для закрытия
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/product_card.js' %}"></script>
{% endblock %}